<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <title>KMeans | What is H2O?</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.0.3">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    
    <link rel="next" href="../hackers_station/grep.html" />
    
    
    <link rel="prev" href="../hackers_station/start_developing_with_h2o.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">

    
    <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-exercises/exercises.css">
    


        
    <div class="book"  data-level="5.1.1" data-basepath=".." data-revision="1416254106586">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="h2o_world_training_sandbox/README.html">
            
                
                    <a href="../h2o_world_training_sandbox/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         H2O World Training Sandbox
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="h2o_in_big_data_environments/README.html">
            
                
                    <a href="../h2o_in_big_data_environments/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         H2O in Big Data environments
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="hands-on_training/README.html">
            
                
                    <a href="../hands-on_training/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         Hands-On Training
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="hands-on_training/h2o_with_the_web_ui.html">
            
                
                    <a href="../hands-on_training/h2o_with_the_web_ui.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         H2O with the Web UI
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="hands-on_training/r_with_h2o.html">
            
                
                    <a href="../hands-on_training/r_with_h2o.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         R with H2O 
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.3" data-path="hands-on_training/supervised_learning_with_regressions.html">
            
                
                    <a href="../hands-on_training/supervised_learning_with_regressions.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                         Supervised Learning
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.3.1" data-path="hands-on_training/regression.html">
            
                
                    <a href="../hands-on_training/regression.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.1.</b>
                        
                         Regression
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.3.2" data-path="hands-on_training/classifications.html">
            
                
                    <a href="../hands-on_training/classifications.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.2.</b>
                        
                         Classifications
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.3.3" data-path="hands-on_training/deep_learning.html">
            
                
                    <a href="../hands-on_training/deep_learning.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.3.</b>
                        
                         Deep Learning
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.4" data-path="hands-on_training/unsupervised_learning.html">
            
                
                    <a href="../hands-on_training/unsupervised_learning.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                         Unsupervised Learning
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.4.1" data-path="hands-on_training/kmeans_clustering.html">
            
                
                    <a href="../hands-on_training/kmeans_clustering.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.1.</b>
                        
                         KMeans Clustering
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.4.2" data-path="hands-on_training/dimensionality_reduction.html">
            
                
                    <a href="../hands-on_training/dimensionality_reduction.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.2.</b>
                        
                         Dimensionality Reduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.4.3" data-path="hands-on_training/anomoly_detection.html">
            
                
                    <a href="../hands-on_training/anomoly_detection.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.3.</b>
                        
                         Anomoly Detection
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.5" data-path="hands-on_training/advanced_topics.html">
            
                
                    <a href="../hands-on_training/advanced_topics.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                         Advanced Topics
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.5.1" data-path="hands-on_training/multi-model_parameter_tuning_for_higgs_dataset.html">
            
                
                    <a href="../hands-on_training/multi-model_parameter_tuning_for_higgs_dataset.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.1.</b>
                        
                         Multi-model Parameter Tuning
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.5.2" data-path="hands-on_training/categorical_feature_engineering.html">
            
                
                    <a href="../hands-on_training/categorical_feature_engineering.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.2.</b>
                        
                         Categorical Feature Engineering
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.5.3" data-path="hands-on_training/tools.html">
            
                
                    <a href="../hands-on_training/tools.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.3.</b>
                        
                         Tools
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3.6" data-path="hands-on_training/practical_use_cases">
            
                
                    <a href="../hands-on_training/practical_use_cases">
                        <i class="fa fa-check"></i>
                        
                            <b>3.6.</b>
                        
                         Practical Use Cases
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="demos/README.html">
            
                
                    <a href="../demos/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         Demos
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="demos/integration_with_tableau_and_excel.html">
            
                
                    <a href="../demos/integration_with_tableau_and_excel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         Tableau
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.2" data-path="demos/excel.html">
            
                
                    <a href="../demos/excel.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                         Excel
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.3" data-path="demos/streaming_data.html">
            
                
                    <a href="../demos/streaming_data.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                         Streaming Data
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="hackers_station/README.html">
            
                
                    <a href="../hackers_station/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         Hackers Station
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="5.1" data-path="hackers_station/start_developing_with_h2o.html">
            
                
                    <a href="../hackers_station/start_developing_with_h2o.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                         Start Developing with H2O
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter active" data-level="5.1.1" data-path="hackers_station/kmeans.html">
            
                
                    <a href="../hackers_station/kmeans.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.1.</b>
                        
                         KMeans
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.1.2" data-path="hackers_station/grep.html">
            
                
                    <a href="../hackers_station/grep.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.2.</b>
                        
                         Grep
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.1.3" data-path="hackers_station/quantiles.html">
            
                
                    <a href="../hackers_station/quantiles.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.3.</b>
                        
                         Quantiles
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5.2" data-path="hackers_station/build_applications_on_top_of_h2o.html">
            
                
                    <a href="../hackers_station/build_applications_on_top_of_h2o.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                         Build Applications on Top of H2O
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.3" data-path="hackers_station/start_with_sparkling_water.html">
            
                
                    <a href="../hackers_station/start_with_sparkling_water.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                         Start with Sparkling Water
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="troubleshooting/README.html">
            
                
                    <a href="../troubleshooting/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         Troubleshooting
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="7" data-path="more_information/README.html">
            
                
                    <a href="../more_information/README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>7.</b>
                        
                         More Information
                    </a>
                
            
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >What is H2O?</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_3992">
                    
                        <h1 id="kmeans">KMeans</h1>
<h1 id="hacking-algorithms-into-hsub2subo-kmeans">Hacking Algorithms into H<sub>2</sub>O: KMeans</h1>
<blockquote>
<p>This is a presentation of hacking a simple algorithm into the new dev-friendly
branch of H2O, <a href="https://github.com/0xdata/h2o-dev/" target="_blank">h2o-dev</a>.</p>
<p>This is one of three &quot;Hacking Algorithms into H2O&quot; tutorials.  All tutorials
start out the same - getting the h2o-dev code and building it.  They are the
same until the section titled <a href="#customizedStartsHere">Building Our Algorithm: Copying from the
Example</a>, and then the content is customized for each
algorithm.  This tutorial describes the algorithm <a href="http://en.wikipedia.org/wiki/K-means_clustering" target="_blank">K-Means</a>.</p>
</blockquote>
<h2 id="what-is-hsub2subo-dev-">What is H<sub>2</sub>O-dev ?</h2>
<p>As I mentioned, H2O-dev is a dev-friendly version of H2O, and is soon to be our
only version.  What does &quot;dev-friendly&quot; mean?  It means:</p>
<ul>
<li><strong>No classloader:</strong> The classloader made H2O very hard to embed in
other projects.  No more!
<a href="http://0xdata.com/blog/2014/09/Sparkling-Water/" target="_blank">Witness H2O&#39;s embedding in Spark</a>.</li>
<li><strong>Fully integrated into IdeaJ:</strong> You can right-click debug-as-junit any of
the junit tests and they will Do The Right Thing in your IDE.</li>
<li><strong>Fully gradle-ized and maven-ized:</strong> Running <code>gradlew build</code> will download
all dependencies, build the project, and run the tests.</li>
</ul>
<p>These are all external points.  However, the code has undergone a major
revision <em>internally</em> as well.  What worked well was left alone, but what
was... gruesome... has been rewritten.  In particular, it&#39;s now much easier to
write the &quot;glue&quot; wrappers around algorithms and get the full GUI, R, REST and
JSON support on your new algorithm.  You still have to write the math, of
course, but there&#39;s not nearly so much pain on the top-level integration.</p>
<p>At some point, we&#39;ll flip the usual <a href="https://github.com/0xdata/h2o/" target="_blank">H2O</a>
github repo to have h2o-dev as our main repo, but at the moment, h2o-dev does
not contain all the functionality in H2O, so it is in its own repo.</p>
<hr>
<h2 id="building-hsub2subo-dev">Building H<sub>2</sub>O-dev</h2>
<p>I assume you are familiar with basic Java development and how github
repo&#39;s work - so we&#39;ll start with a clean github repo of h2o-dev:</p>
<pre><code>    C:\Users\cliffc\Desktop&gt; mkdir my-h2o
    C:\Users\cliffc\Desktop&gt; cd my-h2o
    C:\Users\cliffc\Desktop\my-h2o&gt; git clone https://github.com/0xdata/h2o-dev
</code></pre><p>This will download the h2o-dev source base; took about 30secs for me from home
onto my old-school Windows 7 box.  Then do an initial build:</p>
<pre><code>    C:\Users\cliffc\Desktop\my-h2o&gt; cd h2o-dev
    C:\Users\cliffc\Desktop\my-h2o\h2o-dev&gt; .\gradlew build

    ...
    :h2o-web:test UP-TO-DATE
    :h2o-web:check UP-TO-DATE
    :h2o-web:build

    BUILD SUCCESSFUL

    Total time: 11 mins 41.138 secs
    C:\Users\cliffc\Desktop\my-h2o\h2o-dev&gt;
</code></pre><p>The first build took about 12mins, including all the test runs.  Incremental
gradle-based builds are somewhat faster:</p>
<pre><code>    C:\Users\cliffc\Desktop\my-h2o\h2o-dev&gt; gradle --daemon build -x test

    ...
    :h2o-web:signArchives SKIPPED
    :h2o-web:assemble
    :h2o-web:check
    :h2o-web:build

    BUILD SUCCESSFUL

    Total time: 1 mins 44.645 secs
    C:\Users\cliffc\Desktop\my-h2o\h2o-dev&gt;
</code></pre><p>But faster yet will be IDE-based builds. There&#39;s also a functioning <code>Makefile</code>
setup for old-schoolers like me; it&#39;s a lot faster than gradle for incremental
builds.</p>
<hr>
<p>While that build is going, let&#39;s look at what we got.  There are 4 top-level
directories of interest here:</p>
<ul>
<li><strong><code>h2o-core</code></strong>: The core H2O system - including clustering, clouding,
distributed execution, distributed Key-Value store, the web, REST and JSON
interfaces.  We&#39;ll be looking at the code and javadocs in here - there are a
lot of useful utilities - but not changing it.</li>
<li><strong><code>h2o-algos</code></strong>: Where most of the algorithms lie, including GLM and Deep
Learning.  We&#39;ll be copying the <code>Example</code> algorithm and turning it into
a K-Means algorithm.</li>
<li><strong><code>h2o-web</code></strong>: The web interface and JavaScript.  We will use jar files
from here in our project, but probably not need to look at the code.</li>
<li><strong><code>h2o-app</code></strong>: A tiny sample Application which drives h2o-core and h2o-algos,
including the one we hack in.  We&#39;ll add one line here to teach H2O about our
new algorithm.</li>
</ul>
<p>Within each top-level directory, there is a fairly straightforward maven&#39;ized
directory structure:</p>
<pre><code>    src/main/java - Java source code
    src/test/java - Java  test  code
</code></pre><p>In the Java directories, we further use <code>water</code> directories to hold core H2O
functionality and <code>hex</code> directories to hold algorithms and math:</p>
<pre><code>    src/main/java/water - Java core source code
    src/main/java/hex   - Java math source code
</code></pre><p>Ok, let&#39;s setup our IDE.  For me, since I&#39;m using the default IntelliJ IDEA setup:</p>
<pre><code>    C:\Users\cliffc\Desktop\my-h2o\h2o-dev&gt; gradlew idea

    ...
    :h2o-test-integ:idea
    :h2o-web:ideaModule
    :h2o-web:idea

    BUILD SUCCESSFUL

    Total time: 38.378 secs
    C:\Users\cliffc\Desktop\my-h2o\h2o-dev&gt;
</code></pre><hr>
<h3 id="running-hsub2subo-dev-tests-in-an-ide">Running H<sub>2</sub>O-dev Tests in an IDE</h3>
<p>Then I switched to IDEAJ from my command window.  I launched IDEAJ, selected
&quot;Open Project&quot;, navigated to the <code>h2o-dev/</code> directory and clicked Open.  After IDEAJ opened, I clicked the Make project button (or Build/Make Project or ctrl-F9) and
after a few seconds, IDEAJ reports the project is built (with a few dozen
warnings).</p>
<p>Let&#39;s use IDEAJ to run the JUnit test for the <code>Example</code> algorithm I mentioned
above.  Navigate to the <code>ExampleTest.java</code> file. I used a quick double-press of
Shift to bring the generic project search, then typed some of
<code>ExampleTest.java</code> and selected it from the picker.  Inside the one obvious
<code>testIris()</code> function, right-click and select <code>Debug testIris()</code>.  The testIris code
should run, pass pretty quickly, and generate some output:</p>
<pre><code>    &quot;C:\Program Files\Java\jdk1.7.0_67\bin\java&quot; -agentlib:jdwp=transport=dt_socket....
    Connected to the target VM, address: &#39;127.0.0.1:51321&#39;, transport: &#39;socket&#39;
</code></pre><pre style="background:yellow">
    11-08 13:17:07.536 192.168.1.2:54321     4576   main      INFO: ----- H2O started  -----
    11-08 13:17:07.642 192.168.1.2:54321     4576   main      INFO: Build git branch: master
    11-08 13:17:07.642 192.168.1.2:54321     4576   main      INFO: Build git hash: cdfb4a0f400edc46e00c2b53332c312a96566cf0
    11-08 13:17:07.643 192.168.1.2:54321     4576   main      INFO: Build git describe: RELEASE-0.1.10-7-gcdfb4a0
    11-08 13:17:07.643 192.168.1.2:54321     4576   main      INFO: Build project version: 0.1.11-SNAPSHOT
    11-08 13:17:07.644 192.168.1.2:54321     4576   main      INFO: Built by: 'cliffc'
    11-08 13:17:07.644 192.168.1.2:54321     4576   main      INFO: Built on: '2014-11-08 13:06:53'
    11-08 13:17:07.644 192.168.1.2:54321     4576   main      INFO: Java availableProcessors: 4
    11-08 13:17:07.645 192.168.1.2:54321     4576   main      INFO: Java heap totalMemory: 183.5 MB
    11-08 13:17:07.645 192.168.1.2:54321     4576   main      INFO: Java heap maxMemory: 2.66 GB
    11-08 13:17:07.646 192.168.1.2:54321     4576   main      INFO: Java version: Java 1.7.0_67 (from Oracle Corporation)
    11-08 13:17:07.646 192.168.1.2:54321     4576   main      INFO: OS   version: Windows 7 6.1 (amd64)
    11-08 13:17:07.646 192.168.1.2:54321     4576   main      INFO: Possible IP Address: lo (Software Loopback Interface 1), 127.0.0.1
    11-08 13:17:07.647 192.168.1.2:54321     4576   main      INFO: Possible IP Address: lo (Software Loopback Interface 1), 0:0:0:0:0:0:0:1
    11-08 13:17:07.647 192.168.1.2:54321     4576   main      INFO: Possible IP Address: eth3 (Realtek PCIe GBE Family Controller), 192.168.1.2
    11-08 13:17:07.648 192.168.1.2:54321     4576   main      INFO: Possible IP Address: eth3 (Realtek PCIe GBE Family Controller), fe80:0:0:0:4d5c:8410:671f:dec5%11
    11-08 13:17:07.648 192.168.1.2:54321     4576   main      INFO: Internal communication uses port: 54322
    11-08 13:17:07.648 192.168.1.2:54321     4576   main      INFO: Listening for HTTP and REST traffic on  http://192.168.1.2:54321/
    11-08 13:17:07.649 192.168.1.2:54321     4576   main      INFO: H2O cloud name: 'cliffc' on /192.168.1.2:54321, discovery address /227.18.246.131:58130
    11-08 13:17:07.650 192.168.1.2:54321     4576   main      INFO: If you have trouble connecting, try SSH tunneling from your local machine (e.g., via port 55555):
    11-08 13:17:07.650 192.168.1.2:54321     4576   main      INFO:   1. Open a terminal and run 'ssh -L 55555:localhost:54321 cliffc@192.168.1.2'
    11-08 13:17:07.650 192.168.1.2:54321     4576   main      INFO:   2. Point your browser to http://localhost:55555
    11-08 13:17:07.652 192.168.1.2:54321     4576   main      INFO: Log dir: '\tmp\h2o-cliffc\h2ologs'
    11-08 13:17:07.719 192.168.1.2:54321     4576   main      INFO: Cloud of size 1 formed [/192.168.1.2:54321]
</pre>

<pre style="background:lightblue">
    11-08 13:17:07.722 192.168.1.2:54321     4576   main      INFO: ###########################################################
    11-08 13:17:07.723 192.168.1.2:54321     4576   main      INFO:   * Test class name:  hex.example.ExampleTest
    11-08 13:17:07.723 192.168.1.2:54321     4576   main      INFO:   * Test method name: testIris
    11-08 13:17:07.724 192.168.1.2:54321     4576   main      INFO: ###########################################################
    Start Parse
    11-08 13:17:08.198 192.168.1.2:54321     4576   FJ-0-7    INFO: Parse result for _85a160bc2419316580eeaab88602418e (150 rows):
    11-08 13:17:08.204 192.168.1.2:54321     4576   FJ-0-7    INFO:        Col        type          min          max         NAs constant numLevels
    11-08 13:17:08.205 192.168.1.2:54321     4576   FJ-0-7    INFO:  sepal_len:     numeric      4.30000      7.90000
    11-08 13:17:08.206 192.168.1.2:54321     4576   FJ-0-7    INFO:  sepal_wid:     numeric      2.00000      4.40000
    11-08 13:17:08.207 192.168.1.2:54321     4576   FJ-0-7    INFO:  petal_len:     numeric      1.00000      6.90000
    11-08 13:17:08.208 192.168.1.2:54321     4576   FJ-0-7    INFO:  petal_wid:     numeric     0.100000      2.50000
    11-08 13:17:08.209 192.168.1.2:54321     4576   FJ-0-7    INFO:      class: categorical      0.00000      2.00000                           3
    11-08 13:17:08.212 192.168.1.2:54321     4576   FJ-0-7    INFO: Internal FluidVec compression/distribution summary:
    11-08 13:17:08.212 192.168.1.2:54321     4576   FJ-0-7    INFO: Chunk type    count     fraction       size     rel. size
    11-08 13:17:08.212 192.168.1.2:54321     4576   FJ-0-7    INFO:       C1          1     20.000 %     218  B     19.156 %
    11-08 13:17:08.212 192.168.1.2:54321     4576   FJ-0-7    INFO:      C1S          4     80.000 %     920  B     80.844 %
    11-08 13:17:08.212 192.168.1.2:54321     4576   FJ-0-7    INFO:  Total memory usage :     1.1 KB
    Done Parse: 488
</pre>

<pre style="background:green">
    11-08 13:17:08.304 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 0
    11-08 13:17:08.304 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 1
    11-08 13:17:08.305 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 2
    11-08 13:17:08.306 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 3
    11-08 13:17:08.307 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 4
    11-08 13:17:08.308 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 5
    11-08 13:17:08.309 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 6
    11-08 13:17:08.309 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 7
    11-08 13:17:08.310 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 8
    11-08 13:17:08.311 192.168.1.2:54321     4576   FJ-0-7    INFO: Example: iter: 9
    11-08 13:17:08.315 192.168.1.2:54321     4576   main      INFO: #### TEST hex.example.ExampleTest#testIris EXECUTION TIME: 00:00:00.586 (Wall: 08-Nov 13:17:08.313)
</pre>

<pre><code>    Disconnected from the target VM, address: &#39;127.0.0.1:51321&#39;, transport: &#39;socket&#39;
    Process finished with exit code 0
</code></pre><hr>
<p>Ok, that&#39;s a pretty big pile of output - but buried it in is some cool stuff we&#39;ll need to be able to pick out later, so let&#39;s break it down a little.</p>
<p>The <code style="background:yellow">yellow</code> stuff is H2O booting up a
cluster of 1 JVM.  H2O dumps out a bunch of stuff to diagnose initial cluster
setup problems, including the git build version info, memory assigned to the
JVM, and the network ports found and selected for cluster communication.  This
section ends with the line:</p>
<pre><code>11-08 13:17:07.719 192.168.1.2:54321     4576   main      INFO: Cloud of size 1 formed [/192.168.1.2:54321]
</code></pre><p>This tells us we formed a Cloud of size 1: one JVM will be running our program,
and its IP address is given.</p>
<p>The <code style="background:lightblue">lightblue</code> stuff is our
ExampleTest JUnit test starting up and loading some test data (the venerable
<code>iris</code> dataset with headers, stored in the H2O-dev repo&#39;s
<code>smalldata/iris/</code> directory).  The printout includes some basic stats about the
loaded data (column header names, min/max values, compression ratios).
Included in this output are the lines <code>Start Parse</code> and <code>Done Parse</code>.  These
come directly from the <code>System.out.println(&quot;Start Parse&quot;)</code> lines we can see in
the ExampleTest.java code.</p>
<p>Finally, the <code style="background:green">green</code> stuff is our Example
algorithm running on the test data.  It is a very simple algorithm (finds the
max per column, and does it again and again, once per requested <code>_max_iters</code>).</p>
<hr>
<p><a name="customizedStartsHere"></a></p>
<h2 id="building-our-algorithm-copying-from-the-example">Building Our Algorithm: Copying from the Example</h2>
<p>Now let&#39;s get our own algorithm framework to start playing with in place.
Because H2O-dev already has a KMeans algorithm, that name is
taken...  but we want our own. (Besides just doing it ourselves, there are some
cool extensions to KMeans we can add and sometimes it&#39;s easier to start from a
clean[er] slate).</p>
<p>So this algorithm is called KMeans2 (not too creative, I know).  I cloned the
main code and model from the <code>h2o-algos/src/main/java/hex/example/</code> directory
into <code>h2o-algos/src/main/java/hex/kmeans2/</code>, and also the test from
<code>h2o-algos/src/test/java/hex/example/</code> directory into
<code>h2o-algos/src/test/java/hex/kmeans2/</code>.</p>
<p>Then I copied the three GUI/REST files in <code>h2o-algos/src/main/java/hex/schemas</code>
with Example in the name (<code>ExampleHandler.java</code>, <code>ExampleModelV2.java</code>,
<code>ExampleV2</code>) to their <code>KMeans2*</code> variants.</p>
<p>I also copied the <code>h2o-algos/src/main/java/hex/api/ExampleBuilderHandler.java</code>
file to its <code>KMeans2</code> variant.  Finally I renamed the files <strong>and</strong> file contents
from <code>Example</code> to <code>KMeans2</code>.</p>
<p>I also dove into <code>h2o-app/src/main/java/water/H2OApp.java</code> and copied the two
<code>Example</code> lines and made <strong>their</strong> <code>KMeans2</code> variants.  Because I&#39;m old-school,
I did this with a combination of shell hacking and Emacs; about 5 minutes all
told.</p>
<p>At this point, back in IDEAJ, I nagivated to <code>KMeans2Test.java</code>, right-clicked
debug-test <code>testIris</code> again - and was rewarded with my <code>KMeans2</code> clone running
a basic test.  Not a very good KMeans, but definitely a start.</p>
<h3 id="whats-in-all-those-files">Whats in All Those Files?</h3>
<p>What&#39;s in all those files?  Mainly there is a <code>Model</code> and a <code>ModelBuilder</code>, and
then some support files.</p>
<blockquote>
<p>A <strong>model</strong> is a mathematical representation of the world, an effort to
approximate some interesting fact with numbers.  It is a static concrete
unchanging thing, completely defined by the rules (algorithm) and data used
to make it.</p>
<p>A <strong>model-builder</strong> builds a model; it is transient and active.  It exists as
long as we are actively trying to make a model, and is thrown away once we
have the model in-hand.</p>
</blockquote>
<p>In our case, K-Means is the algorithm - so that belongs in the
<code>KMeans2ModelBuilder.java</code> file, and the result is a set of clusters (a
model), so that belongs in the <code>KMeans2Model.java</code> file.</p>
<p>We also split Schemas from Models - to isolate slow-moving external APIs from
rapidly-moving <em>internal</em> APIs: as a Java dev you can hack the guts of K-Means
to your hearts content - including the inputs and outputs - as long as the
externally facing V2 schemas do not change.  If you want to report new stuff or
take new parameters, you can make a new V3 schema - which is not compatible
with V2 - for the new stuff.  Old external V2 users will not be affected by
your changes (you&#39;ll still have to make the correct mappings in the V2 schema
code from your V3 algorithm).</p>
<p>One other important hack: K-Means is an <em>unsupervised</em> algorithm - no training
data (no &quot;response&quot;) tells it what the results &quot;should&quot; be.  So we need to hack
the word <code>Supervised</code> out of all the various class names it appears in.  After
this is done, your KMeans2Test probably fails to compile, because it is trying
to set the response column name in the test, and unsupervised models do not
get a response to train with.  Just delete the line for now:</p>
<pre><code class="lang-java">    parms._response_column = <span class="hljs-string">"class"</span>;
</code></pre>
<p>At this point we can run our test code again (still finding the max-per-column).</p>
<h3 id="the-kmeans2-model">The KMeans2 Model</h3>
<p>The KMeans2 model, in the file <code>KMeans2Model.java</code>, should contain what we
expect out of K-Means: a set of clusters.  We&#39;ll represent a single cluster as
an N-dimensional point (an array of doubles).  For our K clusters, this will be:</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> _clusters[<span class="hljs-comment">/*K*/</span>][<span class="hljs-comment">/*N*/</span>]; <span class="hljs-comment">// Our K clusters, each an N-dimensional point</span>
</code></pre>
<p>Inside the <code>KMeans2Model</code> class, there is a class for the model&#39;s output:
<code>class KMeans2Output</code>.  We&#39;ll put our clusters there.  The various support
classes and files will make sure our model&#39;s output appears in the correct REST and
JSON responses and gets pretty-printed in the GUI.  There is also the
left-over <code>_maxs</code> array from the old Example code; we can delete that now.</p>
<p>To help assay the <em>goodness</em> our of model, we should also report some extra
facts about the training results.  The obvious thing to report is the Mean
Squared Error, or the average squared-error each training point has against its
chosen cluster:</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> _mse; <span class="hljs-comment">// Mean Squared Error of the training data</span>
</code></pre>
<p>And finally a quick report on the <em>effort</em> used to train: the number of
iterations training actually took.  K-Means runs in iterations, improving with
each iteration.  The algorithm typically stops when the model quits
improving; we report how many iterations it took here:</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> _iters; <span class="hljs-comment">// Iterations we took</span>
</code></pre>
<p>My final <code>KMeans2Output</code> class looks like:</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KMeans2Output</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>.<span class="hljs-title">Output</span> </span>{
      <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> _iters;      <span class="hljs-comment">// Iterations executed</span>
      <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> _clusters[<span class="hljs-comment">/*K*/</span>][<span class="hljs-comment">/*N*/</span>]; <span class="hljs-comment">// Our K clusters, each an N-dimensional point</span>
      <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> _mse;     <span class="hljs-comment">// Mean Squared Error</span>
      <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KMeans2Output</span><span class="hljs-params">( KMeans2 b )</span> </span>{ <span class="hljs-keyword">super</span>(b); }
      <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> ModelCategory <span class="hljs-title">getModelCategory</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> Model.ModelCategory.Clustering; }
    }
</code></pre>
<p>Now, let&#39;s turn to the <em>input</em> to our model-building process.  These are stored
in the <code>class KMeans2Model.KMeans2Parameters</code>.  We already inherit an input
training dataset (returned with <code>train()</code>), possibly a validation dataset
(<code>valid()</code>), and some other helpers (e.g. which columns to ignore if we do
an expensive scoring step with each iteration).  For now, we can ignore
everything except the input dataset from <code>train()</code>.</p>
<p>However, we want some more parameters for K-Means: <code>K</code>, the number of clusters.
Define it next to the left-over <code>_max_iters</code> from the old Example code (which
we might as well keep since that&#39;s a useful stopping conditon for K-Means):</p>
<pre><code class="lang-java">        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> _K;
</code></pre>
<p>My final <code>KMeans2Parameters</code> class looks like:</p>
<pre><code class="lang-java">      <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KMeans2Parameters</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Model</span>.<span class="hljs-title">Parameters</span> </span>{
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> _max_iters = <span class="hljs-number">1000</span>; <span class="hljs-comment">// Max iterations</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> _K = <span class="hljs-number">0</span>;
      }
</code></pre>
<p>A bit on field naming: I always use a leading underscore <code>_</code> before all
internal field names - it lets me know at a glance whether I&#39;m looking at a
field name (stateful, can changed by other threads) or a function parameter
(functional, private).  The distinction becomes interesting when you are
sorting through large piles of code.  There&#39;s no other fundamental reason to
use (or not) the underscores.  <em>External</em> APIs, on the other hand, generally do
not care for leading underscores.  Our JSON output and REST URLs will strip the
underscores from these fields.</p>
<p>To make the GUI functional, I need to add my new K field to the external input
Schema in <code>h2o-algos/src/main/java/hex/schemas/KMeans2V2.java</code>:</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KMeans2ParametersV2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ModelParametersSchema</span>&lt;<span class="hljs-title">KMeans2Model</span>.<span class="hljs-title">KMeans2Parameters</span>, <span class="hljs-title">KMeans2ParametersV2</span>&gt; </span>{
      <span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> String[] own_fields = <span class="hljs-keyword">new</span> String[] { <span class="hljs-string">"max_iters"</span>, <span class="hljs-string">"K"</span>};

      <span class="hljs-comment">// Input fields</span>
      <span class="hljs-annotation">@API</span>(help=<span class="hljs-string">"Maximum training iterations."</span>)  <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> max_iters;
      <span class="hljs-annotation">@API</span>(help=<span class="hljs-string">"K"</span>)  <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> K;
    }
</code></pre>
<p>And I need to add my result fields to the external output schema in
<code>h2o-algos/src/main/java/hex/schemas/KMeans2ModelV2.java</code>:</p>
<pre><code class="lang-java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KMeans2ModelOutputV2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ModelOutputSchema</span>&lt;<span class="hljs-title">KMeans2Model</span>.<span class="hljs-title">KMeans2Output</span>, <span class="hljs-title">KMeans2ModelOutputV2</span>&gt; </span>{
      <span class="hljs-comment">// Output fields</span>
      <span class="hljs-annotation">@API</span>(help=<span class="hljs-string">"Iterations executed"</span>) <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> iters;
      <span class="hljs-annotation">@API</span>(help=<span class="hljs-string">"Cluster centers"</span>) <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> clusters[<span class="hljs-comment">/*K*/</span>][<span class="hljs-comment">/*N*/</span>];
      <span class="hljs-annotation">@API</span>(help=<span class="hljs-string">"Mean Squared Error"</span>) <span class="hljs-keyword">public</span> <span class="hljs-keyword">double</span> mse;
</code></pre>
<h3 id="the-kmeans2-model-builder">The KMeans2 Model Builder</h3>
<p>Let&#39;s turn to the K-Means model builder, which includes some boilerplate we
inherited from the old Example code, and a place to put our real algorithm.
There is a basic <code>KMeans2</code> constructor which calls <code>init</code>:</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">KMeans2</span><span class="hljs-params">( ... )</span> </span>{ <span class="hljs-keyword">super</span>(<span class="hljs-string">"KMeans2"</span>,parms); init(<span class="hljs-keyword">false</span>); }
</code></pre>
<p>In this case, <code>init(false)</code> means &quot;only do cheap stuff in <code>init</code>&quot;.  Init is
defined a little ways down and does basic (cheap) argument checking.
<code>init(false)</code> is called every time the mouse clicks in the GUI and is used to
let the front-end sanity parameters function as people type.  In this case &quot;only do
cheap stuff&quot; really means &quot;only do stuff you don&#39;t mind waiting on while
clicking in the browser&quot;.  No running K-Means in the <code>init()</code> call!</p>
<p>Speaking of the <code>init()</code> call, the one we got from the old Example code limits
our <code>_max_iters</code> to between 1 and 10 million.  Let&#39;s add some lines to check
that K is sane:</p>
<pre><code class="lang-java">    <span class="hljs-keyword">if</span>( _parms._K &lt; <span class="hljs-number">2</span> || _parms._K &gt; <span class="hljs-number">999999</span> )
      error(<span class="hljs-string">"K"</span>,<span class="hljs-string">"must be between 2 and a million"</span>);
</code></pre>
<p>Immediately when testing the code, I get a failure because the
<code>KMeans2Test.java</code> code does not set K and the default is zero.  I&#39;ll set K
to 3 in the test code:</p>
<pre><code class="lang-java">    parms._K = <span class="hljs-number">3</span>;
</code></pre>
<p>In the <code>KMeans2.java</code> file there is a <code>trainModel</code> call that is used when you
really want to start running K-Means (as opposed to just checking arguments).
In our case, the old boilerplate starts a <code>KMeans2Driver</code> in a background
thread.  Not required, but for any long-running algorithm, it is nice to have it
run in the background.  We&#39;ll get progress reports from the GUI (and from
REST/JSON) with the option to cancel the job, or inspect partial results as the
model builds.</p>
<p>The <code>class KMeans2Driver</code> holds the algorithmic meat.  The <code>compute2()</code> call
will be called by a background Fork/Join worker thread to drive all the hard
work.  Again, there is some brief boilerplate we need to go over.</p>
<p>First up: we need to record Keys stored in H2O&#39;s DKV: <strong>Distributed
Key/Value</strong> store, so a later cleanup, <code>Scope.exit();</code>, will wipe out any temp
keys.  When working with Big Data, we have to be careful to clean up after
ourselves - or we can swamp memory with Big Temps.</p>
<pre><code class="lang-java">    Scope.enter();
</code></pre>
<p>Next, we need to prevent the input datasets from being manipulated by other
threads during the model-build process:</p>
<pre><code class="lang-java">    _parms.lock_frames(KMeans2.<span class="hljs-keyword">this</span>);
</code></pre>
<p>Locking prevents situations like accidentally deleting or loading a new dataset
with the same name while K-Means is running.  Like the <code>Scope.exit()</code> above, we
will unlock in <code>finally</code> block.  While it might be nice to use Java locking, or
even JDK 5.0 locks, we need a <em>distributed</em> lock, which is not provided by
JDK 5.0.  Note that H2O locks are strictly cooperative - we cannot
enforce locking at the JVM level like the JVM does.</p>
<p>Next, we make an instance of our model object (with no clusters yet) and place
it in the DKV, locked (e.g., to prevent another user from overwriting our
model-in-progress with an unrelated model).</p>
<pre><code class="lang-java">    model = <span class="hljs-keyword">new</span> KMeans2Model(dest(), _parms, <span class="hljs-keyword">new</span> KMeans2Model.KMeans2Output(KMeans2.<span class="hljs-keyword">this</span>));
    model.delete_and_lock(_key);
</code></pre>
<p>Also, near the file bottom is a leftover <code>class Max</code> from the old Example code.
Might as well nuke it now.</p>
<h3 id="the-kmeans2-main-algorithm">The KMeans2 Main Algorithm</h3>
<p>Finally we get to where the Math is!</p>
<p>K-Means starts with some clusters, generally picked from the dataset
population, and then optimizes the cluster centers and cluster
assignments.  The easiest (but not the best!) way to pick clusters is just to
pick points at (pseudo) random.  So ahead of our iteration/main loop, let&#39;s pick
some clusters.</p>
<pre><code class="lang-java">    <span class="hljs-comment">// Pseudo-random initial cluster selection</span>
    Frame f = train(); <span class="hljs-comment">// Input dataset</span>
    <span class="hljs-keyword">double</span> clusters[<span class="hljs-comment">/*K*/</span>][<span class="hljs-comment">/*N*/</span>] = model._output._clusters = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[_parms._K][f.numCols()];
    Random R = <span class="hljs-keyword">new</span> Random(); <span class="hljs-comment">// Really awful RNG, we should pick a better one later</span>
    <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> k=<span class="hljs-number">0</span>; k&lt;_parms._K; k++ ) {
      <span class="hljs-keyword">long</span> row = Math.abs(R.nextLong() % f.numRows());
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> j=<span class="hljs-number">0</span>; j&lt;f.numCols(); j++ ) <span class="hljs-comment">// Copy the point into our cluster</span>
        clusters[k][j] = f.vecs()[j].at(row);
    }
    model.update(_key); <span class="hljs-comment">// Update model in K/V store</span>
</code></pre>
<p>My <code>KMeans2</code> now has a leftover loop from the old Example code running up to
some max iteration count.  This sounds like a good start to K-Means - we&#39;ll
need several stopping conditions, and max-iterations is one of them.</p>
<pre><code class="lang-java">    <span class="hljs-comment">// Stop after enough iterations</span>
    <span class="hljs-keyword">for</span>( ; model._output._iters &lt; _parms._max_iters; model._output._iters++ ) {
      ...
    }
</code></pre>
<p>Let&#39;s also stop if somebody clicks the &quot;cancel&quot; button in the GUI:</p>
<pre><code class="lang-java">    <span class="hljs-comment">// Stop after enough iterations</span>
    <span class="hljs-keyword">for</span>( ; model._output._iters &lt; _parms._max_iters; model._output._iters++ ) {
      <span class="hljs-keyword">if</span>( !isRunning() ) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// Stopped/cancelled</span>
      ...
    }
</code></pre>
<p>I removed the &quot;compute Max&quot; code from the old Example code in the loop body.
Next up, I see code to record any new <strong>model</strong> (e.g. clusters, mse), and save
the results back into the DKV, bump the progress bar, and log a little bit of
progress:</p>
<pre><code class="lang-java">      <span class="hljs-comment">// Fill in the model</span>
      model._output._clusters = ????? <span class="hljs-comment">// we need to figure these out</span>
      model.update(_key); <span class="hljs-comment">// Update model in K/V store</span>
      update(<span class="hljs-number">1</span>);          <span class="hljs-comment">// One unit of work in the GUI progress bar</span>

      StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();
      sb.append(<span class="hljs-string">"KMeans2: iter: "</span>).append(model._output._iters);
      Log.info(sb);
</code></pre>
<h3 id="the-kmeans2-main-loop">The KMeans2 Main Loop</h3>
<p>And now we need to figure what do in our main loop.  Somewhere between the
loop-top-isRunning check and the <code>model.update()</code> call, we need to compute
something to update our model with!  This is the meat of K-Means - <em>for each
point</em>, assign it to the nearest cluster center, then compute new cluster
centers from the assigned points, and iterate until the clusters quit moving.</p>
<p>Anything that starts out with the words &quot;for each point&quot; when you have a billion
points needs to run in-parallel and scale-out to have a chance of completing
fast - and this is exactly H2O is built for!  So let&#39;s write code that runs
scale-out for-each-point... and the easiest way to do that is with an H2O
Map/Reduce job - an instance of MRTask.  For K-Means, this is an instance of
Lloyd&#39;s basic algorithm.  We&#39;ll call it from the main-loop like this, and
define it below (extra lines included so you can see how it fits):</p>
<pre><code class="lang-java">      <span class="hljs-keyword">if</span>( !isRunning() ) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// Stopped/cancelled</span>

      Lloyds ll = <span class="hljs-keyword">new</span> Lloyds(clusters).doAll(f);
      clusters = model._output._clusters = ArrayUtils.div(ll._sums,ll._rows);
      model._output._mse = ll._se/f.numRows();

      <span class="hljs-comment">// Fill in the model</span>
      model.update(_key); <span class="hljs-comment">// Update model in K/V store</span>
      update(<span class="hljs-number">1</span>);          <span class="hljs-comment">// One unit of work</span>

      StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();
      sb.append(<span class="hljs-string">"KMeans2: iter: "</span>).append(model._output._iters).append(<span class="hljs-string">" MSE="</span>).append(model._output._mse).append(<span class="hljs-string">" ROWS="</span>).append(Arrays.toString(_rows);
      Log.info(sb);
</code></pre>
<p>Let&#39;s also add a stopping condition if the clusters stop moving:</p>
<pre><code class="lang-java">    <span class="hljs-comment">// Stop after enough iterations</span>
    <span class="hljs-keyword">double</span> last_mse = Double.MAX_VALUE; <span class="hljs-comment">// MSE from prior iteration</span>
    <span class="hljs-keyword">for</span>( ; model._output._iters &lt; _parms._max_iters; model._output._iters++ ) {
      <span class="hljs-keyword">if</span>( !isRunning() ) <span class="hljs-keyword">break</span>; <span class="hljs-comment">// Stopped/cancelled</span>

      Lloyds ll = <span class="hljs-keyword">new</span> Lloyds(clusters).doAll(f);
      clusters = model._output._clusters = ArrayUtils.div(ll._sums,ll._rows);
      model._output._mse = ll._se/f.numRows();

      <span class="hljs-comment">// Fill in the model</span>
      model.update(_key); <span class="hljs-comment">// Update model in K/V store</span>
      update(<span class="hljs-number">1</span>);          <span class="hljs-comment">// One unit of work</span>

      StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();
      sb.append(<span class="hljs-string">"KMeans2: iter: "</span>).append(model._output._iters).append(<span class="hljs-string">" MSE="</span>).append(model._output._mse).append(<span class="hljs-string">" ROWS="</span>).append(Arrays.toString(_rows);
      Log.info(sb);

      <span class="hljs-comment">// Also stop if the model stops improving (if MSE stops dropping very much)</span>
      <span class="hljs-keyword">double</span> improv = (last_mse-model._output._mse) / model._output._mse;
      <span class="hljs-keyword">if</span>( improv &lt; <span class="hljs-number">1e-4</span> ) <span class="hljs-keyword">break</span>;
      last_mse = model._output._mse;
    }
</code></pre>
<p>Basically, we just called some not-yet-defined <code>Lloyds</code> code, computed some
cluster centers by computing the average point from the points in the new
cluster, and copied the results into our model.  I also printed out the Mean
Squared Error and row counts, so we can watch the progress over time.  Finally
we end with another stopping condition: stop if the latest model is really not
much better than the last model.  Now <code>class Lloyds</code> can be coded as an inner
class to the <code>KMeans2Driver</code> class:</p>
<pre><code class="lang-java">    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lloyds</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MRTask</span>&lt;<span class="hljs-title">Lloyds</span>&gt; </span>{
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">double</span>[<span class="hljs-comment">/*K*/</span>][<span class="hljs-comment">/*N*/</span>] _clusters; <span class="hljs-comment">// Old cluster</span>
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span>[<span class="hljs-comment">/*K*/</span>][<span class="hljs-comment">/*N*/</span>] _sums;  <span class="hljs-comment">// Sum of points in new cluster</span>
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">long</span>[<span class="hljs-comment">/*K*/</span>] _rows;           <span class="hljs-comment">// Number of points in new cluster</span>
      <span class="hljs-keyword">private</span> <span class="hljs-keyword">double</span> _se;                  <span class="hljs-comment">// Squared Error</span>
      Lloyds( <span class="hljs-keyword">double</span> clusters[][] ) { _clusters = clusters; }
      <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">map</span><span class="hljs-params">( Chunk[] chks )</span> </span>{
        ...
      }
      <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduce</span><span class="hljs-params">( Lloyds ll )</span> </span>{
        ...
      }
    }
</code></pre>
<h4 id="a-quick-hsub2subo-mapreduce-diversion">A Quick H<sub>2</sub>O Map/Reduce Diversion</h4>
<p>This isn&#39;t your Hadoop-Daddy&#39;s Map/Reduce.  This is an in-memory super-fast
map-reduce... where &quot;super-fast&quot; generally means &quot;memory bandwidth limited&quot;,
often 1000x faster than the usual hadoop-variant - MRTasks can often touch a
gigabyte of data in a millisecond, or a terabyte in a second (depending on how much
hardware is in your cluster - more hardware is faster for the same amount of
data!)</p>
<p>The <code>map()</code> call takes data in <code>Chunks</code> - where each <code>Chunk</code> is basically a
small array-like slice of the Big Data.  Data in Chunks is accessed with basic
<code>at0</code> and <code>set0</code> calls (vs accessing data in <code>Vecs</code> with <code>at</code> and <code>set</code>).  The
output of a <code>map()</code> is stored in the <code>Lloyds</code> object itself, as a Plain Olde
Java Object (POJO).  Each <code>map()</code> call has private access to its own fields and
<code>Chunks</code>, which implies there are lots of instances of <code>Lloyds</code> objects
scattered all over the cluster (one such instance per <code>Chunk</code> of data...
well, actually one instance per call to <code>map()</code>, but each map call is handed an
aligned set of Chunks, one per feature or column in the dataset).</p>
<p>Since there are lots of little Lloyds running about, their results need to be
combined.  That&#39;s what <code>reduce</code> does - combine two <code>Lloyds</code> into one.
Typically, you can do this by adding similar fields together - often array
elements are added side-by-side, similar to a <em>saxpy</em> operation.</p>
<p>All code here is written in a single-threaded style, even as it runs in
parallel and distributed.  H2O handles all the synchronization
issues.</p>
<h4 id="a-quick-helper">A Quick Helper</h4>
<p>A common op is to compute the distance between two points.  We&#39;ll compute
it as the squared Euclidean distance (squared so as to avoid an expensive
square-root operation):</p>
<pre><code class="lang-java">    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">double</span> <span class="hljs-title">distance</span><span class="hljs-params">( <span class="hljs-keyword">double</span>[] ds0, <span class="hljs-keyword">double</span>[] ds1 )</span> </span>{
      <span class="hljs-keyword">double</span> sum=<span class="hljs-number">0</span>;
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;ds0.length; i++ )
        sum += (ds0[i]-ds1[i])*(ds0[i]-ds1[i]);
      <span class="hljs-keyword">return</span> sum;
    }
</code></pre>
<h3 id="lloyds">Lloyd&#39;s</h3>
<p>Back to Lloyds, we loop over the <code>Chunk[]</code> of data handed the <code>map</code> call by
moving it as a <code>double[]</code> for easy handling:</p>
<pre><code class="lang-java">    <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">map</span><span class="hljs-params">( Chunk[] chks )</span> </span>{
      <span class="hljs-keyword">double</span>[] ds = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[chks.length];
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> row=<span class="hljs-number">0</span>; row&lt;chks[<span class="hljs-number">0</span>]._len; row++ ) {
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;ds.length; i++ ) ds[i] = chks[i].at0(row);
        ...
      }
    }
</code></pre>
<p>Then we need to find the nearest cluster center:</p>
<pre><code class="lang-java">        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;ds.length; i++ ) ds[i] = chks[i].at0(row);
        <span class="hljs-comment">// Find distance to cluster 0</span>
        <span class="hljs-keyword">int</span> nearest=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">double</span> dist = distance(ds,_clusters[nearest]);
        <span class="hljs-comment">// Find nearest cluster, and its distance</span>
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> k=<span class="hljs-number">1</span>; k&lt;_parms._K; k++ ) {
          <span class="hljs-keyword">double</span> dist2 = distance(ds,_clusters[k]);
          <span class="hljs-keyword">if</span>( dist2 &lt; dist ) { dist = dist2; nearest = k; }
        }
        ...
</code></pre>
<p>And then add the point into our growing pile of points in the new clusters
we&#39;re building:</p>
<pre><code class="lang-java">          <span class="hljs-keyword">if</span>( dist2 &lt; dist ) { dist = dist2; nearest = k; }
        }
        <span class="hljs-comment">// Add the point into the chosen cluster</span>
        ArrayUtils.add(_sums[nearest],ds);
        _rows[nearest]++;
        <span class="hljs-comment">// Accumulate squared-error (which is just squared-distance)</span>
        _se += dist;
</code></pre>
<p>And that ends the <code>map</code> call and the Lloyds main work loop.  To recap, here it
is all at once:</p>
<pre><code class="lang-java">    <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">map</span><span class="hljs-params">( Chunk[] chks )</span> </span>{
      <span class="hljs-keyword">double</span>[] ds = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[chks.length];
      <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> row=<span class="hljs-number">0</span>; row&lt;chks[<span class="hljs-number">0</span>]._len; row++ ) {
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;ds.length; i++ ) ds[i] = chks[i].at0(row);
        <span class="hljs-comment">// Find distance to cluster 0</span>
        <span class="hljs-keyword">int</span> nearest=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">double</span> dist = distance(ds,_clusters[nearest]);
        <span class="hljs-comment">// Find nearest cluster, and its distance</span>
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">int</span> k=<span class="hljs-number">1</span>; k&lt;_parms._K; k++ ) {
          <span class="hljs-keyword">double</span> dist2 = distance(ds,_clusters[k]);
          <span class="hljs-keyword">if</span>( dist2 &lt; dist ) { dist = dist2; nearest = k; }
        }
        <span class="hljs-comment">// Add the point into the chosen cluster</span>
        ArrayUtils.add(_sums[nearest],ds);
        _rows[nearest]++;
        <span class="hljs-comment">// Accumulate squared-error (which is just squared-distance)</span>
        _se += dist;
      }
    }
</code></pre>
<p>The <code>reduce</code> needs to fold together the returned results; the <code>_sums</code>, the
<code>_rows</code> and the <code>_se</code>:</p>
<pre><code class="lang-java">    <span class="hljs-annotation">@Override</span> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reduce</span><span class="hljs-params">( Lloyds ll )</span> </span>{
      ArrayUtils.add(_sums,ll._sums);
      ArrayUtils.add(_rows,ll._rows);
      _se += ll._se;
    }
</code></pre>
<p>And that completes KMeans2!</p>
<hr>
<h2 id="running-k-means">Running K-Means</h2>
<p>Running the KMeans2Test returns:</p>
<pre><code>11-09 16:47:36.609 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 0 1.9077333333333335 ROWS=[66, 34, 50]
11-09 16:47:36.610 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 1 0.6794683457919871 ROWS=[60, 40, 50]
11-09 16:47:36.611 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 2 0.604730388888889 ROWS=[54, 46, 50]
11-09 16:47:36.613 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 3 0.5870257150458589 ROWS=[51, 49, 50]
11-09 16:47:36.614 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 4 0.5828039837094235 ROWS=[50, 50, 50]
11-09 16:47:36.615 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 5 0.5823599999999998 ROWS=[50, 50, 50]
11-09 16:47:36.616 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 6 0.5823599999999998 ROWS=[50, 50, 50]
11-09 16:47:36.618 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 7 0.5823599999999998 ROWS=[50, 50, 50]
11-09 16:47:36.619 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 8 0.5823599999999998 ROWS=[50, 50, 50]
11-09 16:47:36.621 192.168.1.2:54321     3036   FJ-0-7    INFO: KMeans2: iter: 9 0.5823599999999998 ROWS=[50, 50, 50]
</code></pre><p>You can see the Mean Squared Error dropping over time, and the clusters stabilizing.</p>
<p>At this point there are a zillion ways we could take this K-Means:</p>
<ul>
<li>Report <em>MSE</em> on the validation set</li>
<li>Report MSE per-cluster (some clusters will be &#39;tighter&#39; than others)</li>
<li>Run K-Means with different seeds, which will likely build different
clusters - and report the best cluster, or even sort and group them by MSE.</li>
<li>Handle categoricals (e.g. compute Manhattan distance instead of Euclidean)</li>
<li>Normalize the data (optionally, on a flag).  Without normalization features,
larger absolute values will have larger distances (errors) and will get
priority of other features.</li>
<li>Aggressively split high-variance clusters to see if we can get K-Means out of
a local minima</li>
<li>Handle clusters that &quot;run dry&quot; (zero rows), possibly by splitting the point
with the most error/distance out from its cluster to make a new one.</li>
</ul>
<p>I&#39;m sure you can think of lots more ways to extend K-Means!</p>
<p>Good luck with your own H2O algorithm,<br>
Cliff</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../hackers_station/start_developing_with_h2o.html" class="navigation navigation-prev " aria-label="Previous page: Start Developing with H2O"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../hackers_station/grep.html" class="navigation navigation-next " aria-label="Next page: Grep"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-exercises/ace/ace.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-exercises/ace/theme-tomorrow.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-exercises/ace/mode-javascript.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-exercises/exercises.js"></script>
    

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        <script src="../gitbook/plugins/gitbook-plugin-exercises/jsrepl/jsrepl.js" id="jsrepl-script"></script>
    </body>
    
</html>
